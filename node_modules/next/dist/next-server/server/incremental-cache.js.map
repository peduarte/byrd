{"version":3,"sources":["../../../next-server/server/incremental-cache.ts"],"names":["toRoute","pathname","replace","IncrementalCache","constructor","max","dev","distDir","pagesDir","flushToDisk","incrementalOptions","prerenderManifest","cache","version","routes","dynamicRoutes","preview","JSON","parse","path","join","PRERENDER_MANIFEST","LRUCache","length","val","html","stringify","pageData","getSeedPath","ext","calculateRevalidate","curTime","Date","getTime","initialRevalidateSeconds","revalidateAfter","getFallback","page","promises","readFile","get","data","set","_","isStale","manifestEntry","curRevalidate","revalidateSeconds","dataRoute","posix","srcRoute","seedPath","mkdir","dirname","recursive","writeFile","error","console","warn"],"mappings":"qEAAA,sBACA,8EACA,kDAEA,2CACA,wD,mFAEA,QAASA,CAAAA,OAAT,CAAiBC,QAAjB,CAA2C,CACzC,MAAOA,CAAAA,QAAQ,CAACC,OAAT,CAAiB,KAAjB,CAAwB,EAAxB,EAA4BA,OAA5B,CAAoC,UAApC,CAAgD,EAAhD,GAAuD,GAA9D,CACD,CAWM,KAAMC,CAAAA,gBAAiB,CAW5BC,WAAW,CAAC,CACVC,GADU,CAEVC,GAFU,CAGVC,OAHU,CAIVC,QAJU,CAKVC,WALU,CAAD,CAYR,MAtBHC,kBAsBG,aAfHC,iBAeG,aAdHC,KAcG,QACD,KAAKF,kBAAL,CAA0B,CACxBJ,GADwB,CAExBC,OAFwB,CAGxBC,QAHwB,CAIxBC,WAAW,CACT,CAACH,GAAD,GAAS,MAAOG,CAAAA,WAAP,GAAuB,WAAvB,CAAqCA,WAArC,CAAmD,IAA5D,CALsB,CAA1B,CAQA,GAAIH,GAAJ,CAAS,CACP,KAAKK,iBAAL,CAAyB,CACvBE,OAAO,CAAE,CAAC,CADa,CACH;AACpBC,MAAM,CAAE,EAFe,CAGvBC,aAAa,CAAE,EAHQ,CAIvBC,OAAO,CAAE,IAAa;AAJC,CAAzB,CAMD,CAPD,IAOO,CACL,KAAKL,iBAAL,CAAyBM,IAAI,CAACC,KAAL,CACvB,qBAAaC,cAAKC,IAAL,CAAUb,OAAV,CAAmBc,6BAAnB,CAAb,CAAqD,MAArD,CADuB,CAAzB,CAGD,CAED,KAAKT,KAAL,CAAa,GAAIU,kBAAJ,CAAa,CACxB;AACAjB,GAAG,CAAEA,GAAG,EAAI,GAAK,IAAL,CAAY,IAFA,CAGxBkB,MAAM,CAACC,GAAD,CAAM,CACV;AACA,MAAOA,CAAAA,GAAG,CAACC,IAAJ,CAASF,MAAT,CAAkBN,IAAI,CAACS,SAAL,CAAeF,GAAG,CAACG,QAAnB,EAA6BJ,MAAtD,CACD,CANuB,CAAb,CAAb,CAQD,CAEOK,WAAR,CAAoB3B,QAApB,CAAsC4B,GAAtC,CAA2D,CACzD,MAAOV,eAAKC,IAAL,CAAU,KAAKV,kBAAL,CAAwBF,QAAlC,CAA8C,GAAEP,QAAS,IAAG4B,GAAI,EAAhE,CAAP,CACD,CAEOC,mBAAR,CAA4B7B,QAA5B,CAA8D,CAC5DA,QAAQ,CAAGD,OAAO,CAACC,QAAD,CAAlB,CAEA;AACA;AACA,KAAM8B,CAAAA,OAAO,CAAG,GAAIC,CAAAA,IAAJ,GAAWC,OAAX,EAAhB,CACA,GAAI,KAAKvB,kBAAL,CAAwBJ,GAA5B,CAAiC,MAAOyB,CAAAA,OAAO,CAAG,IAAjB,CAEjC,KAAM,CAAEG,wBAAF,EAA+B,KAAKvB,iBAAL,CAAuBG,MAAvB,CACnCb,QADmC,GAEhC,CACHiC,wBAAwB,CAAE,CADvB,CAFL,CAKA,KAAMC,CAAAA,eAAe,CACnB,MAAOD,CAAAA,wBAAP,GAAoC,QAApC,CACIA,wBAAwB,CAAG,IAA3B,CAAkCH,OADtC,CAEIG,wBAHN,CAKA,MAAOC,CAAAA,eAAP,CACD,CAEDC,WAAW,CAACC,IAAD,CAAgC,CACzCA,IAAI,CAAG,yCAAkBA,IAAlB,CAAP,CACA,MAAOC,cAASC,QAAT,CAAkB,KAAKX,WAAL,CAAiBS,IAAjB,CAAuB,MAAvB,CAAlB,CAAkD,MAAlD,CAAP,CACD,CAED;AACA,KAAMG,CAAAA,GAAN,CAAUvC,QAAV,CAAmE,CACjE,GAAI,KAAKS,kBAAL,CAAwBJ,GAA5B,CAAiC,OACjCL,QAAQ,CAAG,yCAAkBA,QAAlB,CAAX,CAEA,GAAIwC,CAAAA,IAAI,CAAG,KAAK7B,KAAL,CAAW4B,GAAX,CAAevC,QAAf,CAAX,CAEA;AACA,GAAI,CAACwC,IAAL,CAAW,CACT,GAAI,CACF,KAAMhB,CAAAA,IAAI,CAAG,KAAMa,cAASC,QAAT,CACjB,KAAKX,WAAL,CAAiB3B,QAAjB,CAA2B,MAA3B,CADiB,CAEjB,MAFiB,CAAnB,CAIA,KAAM0B,CAAAA,QAAQ,CAAGV,IAAI,CAACC,KAAL,CACf,KAAMoB,cAASC,QAAT,CAAkB,KAAKX,WAAL,CAAiB3B,QAAjB,CAA2B,MAA3B,CAAlB,CAAsD,MAAtD,CADS,CAAjB,CAIAwC,IAAI,CAAG,CACLhB,IADK,CAELE,QAFK,CAGLQ,eAAe,CAAE,KAAKL,mBAAL,CAAyB7B,QAAzB,CAHZ,CAAP,CAKA,KAAKW,KAAL,CAAW8B,GAAX,CAAezC,QAAf,CAAyBwC,IAAzB,EACD,CAAC,MAAOE,CAAP,CAAU,CACV;AACD,CACF,CAED,GACEF,IAAI,EACJA,IAAI,CAACN,eAAL,GAAyB,KADzB,EAEAM,IAAI,CAACN,eAAL,CAAuB,GAAIH,CAAAA,IAAJ,GAAWC,OAAX,EAHzB,CAIE,CACAQ,IAAI,CAACG,OAAL,CAAe,IAAf,CACD,CACD,KAAMC,CAAAA,aAAa,CAAG,KAAKlC,iBAAL,CAAuBG,MAAvB,CAA8Bb,QAA9B,CAAtB,CAEA,GAAIwC,IAAI,EAAII,aAAZ,CAA2B,CACzBJ,IAAI,CAACK,aAAL,CAAqBD,aAAa,CAACX,wBAAnC,CACD,CACD,MAAOO,CAAAA,IAAP,CACD,CAED;AACA,KAAMC,CAAAA,GAAN,CACEzC,QADF,CAEEwC,IAFF,CAMEM,iBANF,CAOE,CACA,GAAI,KAAKrC,kBAAL,CAAwBJ,GAA5B,CAAiC,OACjC,GAAI,MAAOyC,CAAAA,iBAAP,GAA6B,WAAjC,CAA8C,CAC5C;AACA;AACA,KAAKpC,iBAAL,CAAuBG,MAAvB,CAA8Bb,QAA9B,EAA0C,CACxC+C,SAAS,CAAE7B,cAAK8B,KAAL,CAAW7B,IAAX,CACT,aADS,CAER,GAAE,yCAAkBnB,QAAlB,CAA4B,OAFtB,CAD6B,CAKxCiD,QAAQ,CAAE,IAL8B,CAKxB;AAChBhB,wBAAwB,CAAEa,iBANc,CAA1C,CAQD,CAED9C,QAAQ,CAAG,yCAAkBA,QAAlB,CAAX,CACA,KAAKW,KAAL,CAAW8B,GAAX,CAAezC,QAAf,CAAyB,CACvB,GAAGwC,IADoB,CAEvBN,eAAe,CAAE,KAAKL,mBAAL,CAAyB7B,QAAzB,CAFM,CAAzB,EAKA;AACA;AACA,GAAI,KAAKS,kBAAL,CAAwBD,WAA5B,CAAyC,CACvC,GAAI,CACF,KAAM0C,CAAAA,QAAQ,CAAG,KAAKvB,WAAL,CAAiB3B,QAAjB,CAA2B,MAA3B,CAAjB,CACA,KAAMqC,cAASc,KAAT,CAAejC,cAAKkC,OAAL,CAAaF,QAAb,CAAf,CAAuC,CAAEG,SAAS,CAAE,IAAb,CAAvC,CAAN,CACA,KAAMhB,cAASiB,SAAT,CAAmBJ,QAAnB,CAA6BV,IAAI,CAAChB,IAAlC,CAAwC,MAAxC,CAAN,CACA,KAAMa,cAASiB,SAAT,CACJ,KAAK3B,WAAL,CAAiB3B,QAAjB,CAA2B,MAA3B,CADI,CAEJgB,IAAI,CAACS,SAAL,CAAee,IAAI,CAACd,QAApB,CAFI,CAGJ,MAHI,CAAN,CAKD,CAAC,MAAO6B,KAAP,CAAc,CACd;AACAC,OAAO,CAACC,IAAR,CAAa,sCAAb,CAAqDzD,QAArD,CAA+DuD,KAA/D,EACD,CACF,CACF,CA/K2B,C","sourcesContent":["import { promises, readFileSync } from 'fs'\nimport LRUCache from 'next/dist/compiled/lru-cache'\nimport path from 'path'\nimport { PrerenderManifest } from '../../build'\nimport { PRERENDER_MANIFEST } from '../lib/constants'\nimport { normalizePagePath } from './normalize-page-path'\n\nfunction toRoute(pathname: string): string {\n  return pathname.replace(/\\/$/, '').replace(/\\/index$/, '') || '/'\n}\n\ntype IncrementalCacheValue = {\n  html: string\n  pageData: any\n  isStale?: boolean\n  curRevalidate?: number | false\n  // milliseconds to revalidate after\n  revalidateAfter: number | false\n}\n\nexport class IncrementalCache {\n  incrementalOptions: {\n    flushToDisk?: boolean\n    pagesDir?: string\n    distDir?: string\n    dev?: boolean\n  }\n\n  prerenderManifest: PrerenderManifest\n  cache: LRUCache<string, IncrementalCacheValue>\n\n  constructor({\n    max,\n    dev,\n    distDir,\n    pagesDir,\n    flushToDisk,\n  }: {\n    dev: boolean\n    max?: number\n    distDir: string\n    pagesDir: string\n    flushToDisk?: boolean\n  }) {\n    this.incrementalOptions = {\n      dev,\n      distDir,\n      pagesDir,\n      flushToDisk:\n        !dev && (typeof flushToDisk !== 'undefined' ? flushToDisk : true),\n    }\n\n    if (dev) {\n      this.prerenderManifest = {\n        version: -1 as any, // letting us know this doesn't conform to spec\n        routes: {},\n        dynamicRoutes: {},\n        preview: null as any, // `preview` is special case read in next-dev-server\n      }\n    } else {\n      this.prerenderManifest = JSON.parse(\n        readFileSync(path.join(distDir, PRERENDER_MANIFEST), 'utf8')\n      )\n    }\n\n    this.cache = new LRUCache({\n      // default to 50MB limit\n      max: max || 50 * 1024 * 1024,\n      length(val) {\n        // rough estimate of size of cache value\n        return val.html.length + JSON.stringify(val.pageData).length\n      },\n    })\n  }\n\n  private getSeedPath(pathname: string, ext: string): string {\n    return path.join(this.incrementalOptions.pagesDir!, `${pathname}.${ext}`)\n  }\n\n  private calculateRevalidate(pathname: string): number | false {\n    pathname = toRoute(pathname)\n\n    // in development we don't have a prerender-manifest\n    // and default to always revalidating to allow easier debugging\n    const curTime = new Date().getTime()\n    if (this.incrementalOptions.dev) return curTime - 1000\n\n    const { initialRevalidateSeconds } = this.prerenderManifest.routes[\n      pathname\n    ] || {\n      initialRevalidateSeconds: 1,\n    }\n    const revalidateAfter =\n      typeof initialRevalidateSeconds === 'number'\n        ? initialRevalidateSeconds * 1000 + curTime\n        : initialRevalidateSeconds\n\n    return revalidateAfter\n  }\n\n  getFallback(page: string): Promise<string> {\n    page = normalizePagePath(page)\n    return promises.readFile(this.getSeedPath(page, 'html'), 'utf8')\n  }\n\n  // get data from cache if available\n  async get(pathname: string): Promise<IncrementalCacheValue | void> {\n    if (this.incrementalOptions.dev) return\n    pathname = normalizePagePath(pathname)\n\n    let data = this.cache.get(pathname)\n\n    // let's check the disk for seed data\n    if (!data) {\n      try {\n        const html = await promises.readFile(\n          this.getSeedPath(pathname, 'html'),\n          'utf8'\n        )\n        const pageData = JSON.parse(\n          await promises.readFile(this.getSeedPath(pathname, 'json'), 'utf8')\n        )\n\n        data = {\n          html,\n          pageData,\n          revalidateAfter: this.calculateRevalidate(pathname),\n        }\n        this.cache.set(pathname, data)\n      } catch (_) {\n        // unable to get data from disk\n      }\n    }\n\n    if (\n      data &&\n      data.revalidateAfter !== false &&\n      data.revalidateAfter < new Date().getTime()\n    ) {\n      data.isStale = true\n    }\n    const manifestEntry = this.prerenderManifest.routes[pathname]\n\n    if (data && manifestEntry) {\n      data.curRevalidate = manifestEntry.initialRevalidateSeconds\n    }\n    return data\n  }\n\n  // populate the incremental cache with new data\n  async set(\n    pathname: string,\n    data: {\n      html: string\n      pageData: any\n    },\n    revalidateSeconds?: number | false\n  ) {\n    if (this.incrementalOptions.dev) return\n    if (typeof revalidateSeconds !== 'undefined') {\n      // TODO: Update this to not mutate the manifest from the\n      // build.\n      this.prerenderManifest.routes[pathname] = {\n        dataRoute: path.posix.join(\n          '/_next/data',\n          `${normalizePagePath(pathname)}.json`\n        ),\n        srcRoute: null, // FIXME: provide actual source route, however, when dynamically appending it doesn't really matter\n        initialRevalidateSeconds: revalidateSeconds,\n      }\n    }\n\n    pathname = normalizePagePath(pathname)\n    this.cache.set(pathname, {\n      ...data,\n      revalidateAfter: this.calculateRevalidate(pathname),\n    })\n\n    // TODO: This option needs to cease to exist unless it stops mutating the\n    // `next build` output's manifest.\n    if (this.incrementalOptions.flushToDisk) {\n      try {\n        const seedPath = this.getSeedPath(pathname, 'html')\n        await promises.mkdir(path.dirname(seedPath), { recursive: true })\n        await promises.writeFile(seedPath, data.html, 'utf8')\n        await promises.writeFile(\n          this.getSeedPath(pathname, 'json'),\n          JSON.stringify(data.pageData),\n          'utf8'\n        )\n      } catch (error) {\n        // failed to flush to disk\n        console.warn('Failed to update prerender files for', pathname, error)\n      }\n    }\n  }\n}\n"]}