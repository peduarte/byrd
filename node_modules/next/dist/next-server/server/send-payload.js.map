{"version":3,"sources":["../../../next-server/server/send-payload.ts"],"names":["sendPayload","req","res","payload","type","generateEtags","poweredByHeader","options","setHeader","etag","undefined","headers","statusCode","end","getHeader","Buffer","byteLength","private","stateful","hasHeader","revalidate","Error","method"],"mappings":"qEACA,mCACA,qEACA,uE,mFAEO,QAASA,CAAAA,WAAT,CACLC,GADK,CAELC,GAFK,CAGLC,OAHK,CAILC,IAJK,CAKL,CACEC,aADF,CAEEC,eAFF,CALK,CASLC,OATK,CAaC,CACN,GAAI,qBAAUL,GAAV,CAAJ,CAAoB,CAClB,OACD,CAED,GAAII,eAAe,EAAIF,IAAI,GAAK,MAAhC,CAAwC,CACtCF,GAAG,CAACM,SAAJ,CAAc,cAAd,CAA8B,SAA9B,EACD,CAED,KAAMC,CAAAA,IAAI,CAAGJ,aAAa,CAAG,kBAAaF,OAAb,CAAH,CAA2BO,SAArD,CAEA,GAAI,mBAAMT,GAAG,CAACU,OAAV,CAAmB,CAAEF,IAAF,CAAnB,CAAJ,CAAkC,CAChCP,GAAG,CAACU,UAAJ,CAAiB,GAAjB,CACAV,GAAG,CAACW,GAAJ,GACA,OACD,CAED,GAAIJ,IAAJ,CAAU,CACRP,GAAG,CAACM,SAAJ,CAAc,MAAd,CAAsBC,IAAtB,EACD,CAED,GAAI,CAACP,GAAG,CAACY,SAAJ,CAAc,cAAd,CAAL,CAAoC,CAClCZ,GAAG,CAACM,SAAJ,CACE,cADF,CAEEJ,IAAI,GAAK,MAAT,CAAkB,kBAAlB,CAAuC,0BAFzC,EAID,CACDF,GAAG,CAACM,SAAJ,CAAc,gBAAd,CAAgCO,MAAM,CAACC,UAAP,CAAkBb,OAAlB,CAAhC,EACA,GAAII,OAAO,EAAI,IAAf,CAAqB,CACnB,GAAIA,OAAO,CAACU,OAAR,EAAmBV,OAAO,CAACW,QAA/B,CAAyC,CACvC,GAAIX,OAAO,CAACU,OAAR,EAAmB,CAACf,GAAG,CAACiB,SAAJ,CAAc,eAAd,CAAxB,CAAwD,CACtDjB,GAAG,CAACM,SAAJ,CACE,eADF,CAEG,yDAFH,EAID,CACF,CAPD,IAOO,IAAI,MAAOD,CAAAA,OAAO,CAACa,UAAf,GAA8B,QAAlC,CAA4C,CACjD,GAAIb,OAAO,CAACa,UAAR,CAAqB,CAAzB,CAA4B,CAC1B,KAAM,IAAIC,CAAAA,KAAJ,CACH,uDAAsDd,OAAO,CAACa,UAAW,MADtE,CAAN,CAGD,CAEDlB,GAAG,CAACM,SAAJ,CACE,eADF,CAEG,YAAWD,OAAO,CAACa,UAAW,0BAFjC,EAID,CAXM,IAWA,IAAIb,OAAO,CAACa,UAAR,GAAuB,KAA3B,CAAkC,CACvClB,GAAG,CAACM,SAAJ,CACE,eADF,CAEG,2CAFH,EAID,CACF,CACDN,GAAG,CAACW,GAAJ,CAAQZ,GAAG,CAACqB,MAAJ,GAAe,MAAf,CAAwB,IAAxB,CAA+BnB,OAAvC,EACD","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { isResSent } from '../lib/utils'\nimport generateETag from 'next/dist/compiled/etag'\nimport fresh from 'next/dist/compiled/fresh'\n\nexport function sendPayload(\n  req: IncomingMessage,\n  res: ServerResponse,\n  payload: any,\n  type: 'html' | 'json',\n  {\n    generateEtags,\n    poweredByHeader,\n  }: { generateEtags: boolean; poweredByHeader: boolean },\n  options?:\n    | { private: true }\n    | { private: boolean; stateful: true }\n    | { private: boolean; stateful: false; revalidate: number | false }\n): void {\n  if (isResSent(res)) {\n    return\n  }\n\n  if (poweredByHeader && type === 'html') {\n    res.setHeader('X-Powered-By', 'Next.js')\n  }\n\n  const etag = generateEtags ? generateETag(payload) : undefined\n\n  if (fresh(req.headers, { etag })) {\n    res.statusCode = 304\n    res.end()\n    return\n  }\n\n  if (etag) {\n    res.setHeader('ETag', etag)\n  }\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader(\n      'Content-Type',\n      type === 'json' ? 'application/json' : 'text/html; charset=utf-8'\n    )\n  }\n  res.setHeader('Content-Length', Buffer.byteLength(payload))\n  if (options != null) {\n    if (options.private || options.stateful) {\n      if (options.private || !res.hasHeader('Cache-Control')) {\n        res.setHeader(\n          'Cache-Control',\n          `private, no-cache, no-store, max-age=0, must-revalidate`\n        )\n      }\n    } else if (typeof options.revalidate === 'number') {\n      if (options.revalidate < 1) {\n        throw new Error(\n          `invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`\n        )\n      }\n\n      res.setHeader(\n        'Cache-Control',\n        `s-maxage=${options.revalidate}, stale-while-revalidate`\n      )\n    } else if (options.revalidate === false) {\n      res.setHeader(\n        'Cache-Control',\n        `s-maxage=31536000, stale-while-revalidate`\n      )\n    }\n  }\n  res.end(req.method === 'HEAD' ? null : payload)\n}\n"]}