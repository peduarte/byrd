{"version":3,"sources":["../../../build/plugins/collect-plugins.ts"],"names":["VALID_MIDDLEWARE","exitWithError","error","console","process","exit","collectPluginMeta","env","pluginPackagePath","pkgDir","path","dirname","pluginPackageJson","require","pluginMetaData","nextjs","name","middleware","promises","readdir","join","withFileTypes","filter","dirent","isFile","map","file","err","code","item","parts","split","pop","invalidMiddleware","includes","push","length","Array","isArray","missingEnvFields","field","directory","replace","requiredEnv","version","pluginName","pkgName","getPluginId","pkg","match","_collectPlugins","dir","pluginsConfig","nextPluginNames","skippedPluginNames","hasPluginConfig","nextPluginConfigNames","config","rootPackageJsonPath","cwd","log","rootPackageJson","dependencies","concat","Object","keys","devDependencies","filteredDeps","dep","nextPluginMetaData","Promise","all","resolve","sync","basedir","preserveSymlinks","plugin","curPlugin","find","collectPlugins"],"mappings":"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","sourcesContent":["import findUp from 'next/dist/compiled/find-up'\nimport { promises } from 'fs'\nimport path from 'path'\nimport resolve from 'next/dist/compiled/resolve/index.js'\nimport { execOnce } from '../../next-server/lib/utils'\n\nexport type PluginMetaData = {\n  requiredEnv: string[]\n  middleware: string[]\n  pluginName: string\n  directory: string\n  pkgName: string\n  version: string\n  config?: { [name: string]: any }\n}\n\n// currently supported middleware\nexport const VALID_MIDDLEWARE = [\n  'document-head-tags-server',\n  'on-init-client',\n  'on-init-server',\n  'on-error-server',\n  'on-error-client',\n  'on-error-client',\n  'on-error-server',\n  'babel-preset-build',\n]\n\ntype ENV_OPTIONS = { [name: string]: string }\n\nconst exitWithError = (error: string) => {\n  console.error(error)\n  process.exit(1)\n}\n\nasync function collectPluginMeta(\n  env: ENV_OPTIONS,\n  pluginPackagePath: string\n): Promise<PluginMetaData> {\n  const pkgDir = path.dirname(pluginPackagePath)\n  const pluginPackageJson = require(pluginPackagePath)\n  const pluginMetaData: {\n    name: string\n    'required-env': string[]\n  } = pluginPackageJson.nextjs\n\n  if (!pluginMetaData) {\n    exitWithError('Next.js plugins need to have a \"nextjs\" key in package.json')\n  }\n\n  if (!pluginMetaData.name) {\n    exitWithError(\n      'Next.js plugins need to have a \"nextjs.name\" key in package.json'\n    )\n  }\n\n  // TODO: add err.sh explaining requirements\n  let middleware: string[] = []\n  try {\n    middleware = (\n      await promises.readdir(path.join(pkgDir, 'src'), { withFileTypes: true })\n    )\n      .filter((dirent) => dirent.isFile())\n      .map((file) => file.name)\n  } catch (err) {\n    if (err.code !== 'ENOENT') {\n      console.error(err)\n    }\n    exitWithError(\n      `Failed to read src/ directory for Next.js plugin: ${pluginMetaData.name}`\n    )\n  }\n\n  // remove the extension from the middleware\n  middleware = middleware.map((item) => {\n    const parts = item.split('.')\n    parts.pop()\n    return parts.join('.')\n  })\n\n  const invalidMiddleware: string[] = []\n\n  for (const item of middleware) {\n    if (!VALID_MIDDLEWARE.includes(item)) {\n      invalidMiddleware.push(item)\n    }\n  }\n\n  if (invalidMiddleware.length > 0) {\n    console.error(\n      `Next.js Plugin: ${\n        pluginMetaData.name\n      } listed invalid middleware ${invalidMiddleware.join(', ')}`\n    )\n  }\n\n  // TODO: investigate requiring plugins' env be prefixed\n  // somehow to prevent collision\n  if (!Array.isArray(pluginMetaData['required-env'])) {\n    exitWithError(\n      'Next.js plugins need to have a \"nextjs.required-env\" key in package.json'\n    )\n  }\n\n  const missingEnvFields: string[] = []\n\n  for (const field of pluginMetaData['required-env']) {\n    if (typeof env[field] === 'undefined') {\n      missingEnvFields.push(field)\n    }\n  }\n\n  if (missingEnvFields.length > 0) {\n    exitWithError(\n      `Next.js Plugin: ${\n        pluginMetaData.name\n      } required env ${missingEnvFields.join(\n        ', '\n      )} but was missing in your \\`next.config.js\\``\n    )\n  }\n\n  return {\n    middleware,\n    directory: pkgDir.replace(/\\\\/g, '/'),\n    requiredEnv: pluginMetaData['required-env'],\n    version: pluginPackageJson.version,\n    pluginName: pluginMetaData.name,\n    pkgName: pluginPackageJson.name,\n  }\n}\n\n// clean package name so it can be used as variable\nexport const getPluginId = (pkg: string): string => {\n  pkg = pkg.replace(/\\W/g, '')\n\n  if (pkg.match(/^[0-9]/)) {\n    pkg = `_${pkg}`\n  }\n  return pkg\n}\n\ntype PluginConfig =\n  | string\n  | {\n      name: string\n      config: { [name: string]: any }\n    }\n\nasync function _collectPlugins(\n  dir: string,\n  env: ENV_OPTIONS,\n  pluginsConfig: PluginConfig[] | undefined\n): Promise<PluginMetaData[]> {\n  let nextPluginNames: string[] = []\n  const skippedPluginNames: string[] = []\n  const hasPluginConfig = Array.isArray(pluginsConfig)\n\n  const nextPluginConfigNames = hasPluginConfig\n    ? pluginsConfig!.map((config) =>\n        typeof config === 'string' ? config : config.name\n      )\n    : null\n\n  const rootPackageJsonPath = await findUp('package.json', { cwd: dir })\n  if (!rootPackageJsonPath && !nextPluginConfigNames) {\n    console.log('Failed to load plugins, no package.json')\n    return []\n  }\n\n  if (rootPackageJsonPath) {\n    const rootPackageJson = require(rootPackageJsonPath)\n    let dependencies: string[] = []\n    if (rootPackageJson.dependencies) {\n      dependencies = dependencies.concat(\n        Object.keys(rootPackageJson.dependencies)\n      )\n    }\n\n    if (rootPackageJson.devDependencies) {\n      dependencies = dependencies.concat(\n        Object.keys(rootPackageJson.devDependencies)\n      )\n    }\n\n    // find packages with the naming convention\n    // @scope/next-plugin-[name]\n    // @next/plugin-[name]\n    // next-plugin-[name]\n    const filteredDeps = dependencies.filter((name) => {\n      return name.match(/(^@next\\/plugin|next-plugin-)/)\n    })\n\n    if (nextPluginConfigNames) {\n      for (const dep of filteredDeps) {\n        if (!nextPluginConfigNames.includes(dep)) {\n          skippedPluginNames.push(dep)\n        }\n      }\n      nextPluginNames = nextPluginConfigNames\n    } else {\n      nextPluginNames = filteredDeps\n    }\n  }\n\n  const nextPluginMetaData = await Promise.all(\n    nextPluginNames.map((name) =>\n      collectPluginMeta(\n        env,\n        resolve.sync(path.join(name, 'package.json'), {\n          basedir: dir,\n          preserveSymlinks: true,\n        })\n      )\n    )\n  )\n\n  for (const plugin of nextPluginMetaData) {\n    // Add plugin config from `next.config.js`\n    if (hasPluginConfig) {\n      const curPlugin = pluginsConfig!.find(\n        (config) =>\n          config && typeof config === 'object' && config.name === plugin.pkgName\n      )\n      if (curPlugin && typeof curPlugin === 'object') {\n        plugin.config = curPlugin.config\n      }\n    }\n    console.log(\n      `Loaded plugin: ${plugin.pkgName}${\n        plugin.version ? `@${plugin.version}` : ''\n      }`\n    )\n  }\n\n  if (skippedPluginNames.length) {\n    console.log(\n      `Plugins config used skipped loading: ${skippedPluginNames.join(', ')}`\n    )\n  }\n  console.log()\n\n  return nextPluginMetaData\n}\n\n// only execute it once between server/client configs\n// since the plugins need to match\nexport const collectPlugins = execOnce(_collectPlugins)\n"]}