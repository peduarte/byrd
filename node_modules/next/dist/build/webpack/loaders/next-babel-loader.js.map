{"version":3,"sources":["../../../../build/webpack/loaders/next-babel-loader.js"],"names":["cacheKey","nextBabelPreset","require","getModernOptions","babelOptions","presetEnvOptions","Object","assign","transformRuntimeOptions","regenerator","targets","esmodules","exclude","nextBabelPresetModern","presetOptions","context","module","exports","babelLoader","custom","babel","presetItem","createConfigItem","type","applyCommonJs","commonJsItem","configs","Set","customOptions","opts","isServer","isModern","pagesDir","hasModern","babelPresetPlugins","development","hasReactRefresh","filename","cwd","loader","cache","cacheCompression","cacheDirectory","distDir","cacheIdentifier","JSON","stringify","loadPartialConfig","sourceFileName","options","config","cfg","source","resourcePath","isPageFile","startsWith","hasFilesystemConfig","file","babelrc","has","add","Log","info","presets","caller","isDev","emitWarning","bind","defineProperty","enumerable","writable","value","onWarning","reason","Error","plugins","reactRefreshPlugin","skipEnvCheck","unshift","noAnonymousDefaultExportPlugin","pageConfigPlugin","push","indexOf","nextDataPlugin","key","nextPreset","find","preset","additionalPresets","filter","presetItemModern","resolve","overrides","test","plugin","dir"],"mappings":"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","sourcesContent":["import babelLoader from 'next/dist/compiled/babel-loader'\nimport hash from 'next/dist/compiled/string-hash'\nimport { basename, join } from 'path'\nimport * as Log from '../../output/log'\n\n// increment 'm' to invalidate cache\n// eslint-disable-next-line no-useless-concat\nconst cacheKey = 'babel-cache-' + 'm' + '-'\nconst nextBabelPreset = require('../../babel/preset')\n\nconst getModernOptions = (babelOptions = {}) => {\n  const presetEnvOptions = Object.assign({}, babelOptions['preset-env'])\n  const transformRuntimeOptions = Object.assign(\n    {},\n    babelOptions['transform-runtime'],\n    { regenerator: false }\n  )\n\n  presetEnvOptions.targets = {\n    esmodules: true,\n  }\n  presetEnvOptions.exclude = [\n    ...(presetEnvOptions.exclude || []),\n    // Block accidental inclusions\n    'transform-regenerator',\n    'transform-async-to-generator',\n  ]\n\n  return {\n    ...babelOptions,\n    'preset-env': presetEnvOptions,\n    'transform-runtime': transformRuntimeOptions,\n  }\n}\n\nconst nextBabelPresetModern = (presetOptions) => (context) =>\n  nextBabelPreset(context, getModernOptions(presetOptions))\n\nmodule.exports = babelLoader.custom((babel) => {\n  const presetItem = babel.createConfigItem(nextBabelPreset, {\n    type: 'preset',\n  })\n  const applyCommonJs = babel.createConfigItem(\n    require('../../babel/plugins/commonjs'),\n    { type: 'plugin' }\n  )\n  const commonJsItem = babel.createConfigItem(\n    require('@babel/plugin-transform-modules-commonjs'),\n    { type: 'plugin' }\n  )\n\n  const configs = new Set()\n\n  return {\n    customOptions(opts) {\n      const custom = {\n        isServer: opts.isServer,\n        isModern: opts.isModern,\n        pagesDir: opts.pagesDir,\n        hasModern: opts.hasModern,\n        babelPresetPlugins: opts.babelPresetPlugins,\n        development: opts.development,\n        hasReactRefresh: opts.hasReactRefresh,\n      }\n      const filename = join(opts.cwd, 'noop.js')\n      const loader = Object.assign(\n        opts.cache\n          ? {\n              cacheCompression: false,\n              cacheDirectory: join(opts.distDir, 'cache', 'next-babel-loader'),\n              cacheIdentifier:\n                cacheKey +\n                (opts.isServer ? '-server' : '') +\n                (opts.isModern ? '-modern' : '') +\n                (opts.hasModern ? '-has-modern' : '') +\n                '-new-polyfills' +\n                (opts.development ? '-development' : '-production') +\n                (opts.hasReactRefresh ? '-react-refresh' : '') +\n                JSON.stringify(\n                  babel.loadPartialConfig({\n                    filename,\n                    cwd: opts.cwd,\n                    sourceFileName: filename,\n                  }).options\n                ),\n            }\n          : {\n              cacheDirectory: false,\n            },\n        opts\n      )\n\n      delete loader.isServer\n      delete loader.cache\n      delete loader.distDir\n      delete loader.isModern\n      delete loader.hasModern\n      delete loader.pagesDir\n      delete loader.babelPresetPlugins\n      delete loader.development\n      delete loader.hasReactRefresh\n      return { loader, custom }\n    },\n    config(\n      cfg,\n      {\n        source,\n        customOptions: {\n          isServer,\n          isModern,\n          hasModern,\n          pagesDir,\n          babelPresetPlugins,\n          development,\n          hasReactRefresh,\n        },\n      }\n    ) {\n      const filename = this.resourcePath\n      const options = Object.assign({}, cfg.options)\n      const isPageFile = filename.startsWith(pagesDir)\n\n      if (cfg.hasFilesystemConfig()) {\n        for (const file of [cfg.babelrc, cfg.config]) {\n          // We only log for client compilation otherwise there will be double output\n          if (file && !isServer && !configs.has(file)) {\n            configs.add(file)\n            Log.info(`Using external babel configuration from ${file}`)\n          }\n        }\n      } else {\n        // Add our default preset if the no \"babelrc\" found.\n        options.presets = [...options.presets, presetItem]\n      }\n\n      options.caller.isServer = isServer\n      options.caller.isModern = isModern\n      options.caller.isDev = development\n\n      const emitWarning = this.emitWarning.bind(this)\n      Object.defineProperty(options.caller, 'onWarning', {\n        enumerable: false,\n        writable: false,\n        value: (options.caller.onWarning = function (reason) {\n          if (!(reason instanceof Error)) {\n            reason = new Error(reason)\n          }\n          emitWarning(reason)\n        }),\n      })\n\n      options.plugins = options.plugins || []\n\n      if (hasReactRefresh) {\n        const reactRefreshPlugin = babel.createConfigItem(\n          [require('react-refresh/babel'), { skipEnvCheck: true }],\n          { type: 'plugin' }\n        )\n        options.plugins.unshift(reactRefreshPlugin)\n        if (!isServer) {\n          const noAnonymousDefaultExportPlugin = babel.createConfigItem(\n            [require('../../babel/plugins/no-anonymous-default-export'), {}],\n            { type: 'plugin' }\n          )\n          options.plugins.unshift(noAnonymousDefaultExportPlugin)\n        }\n      }\n\n      if (!isServer && isPageFile) {\n        const pageConfigPlugin = babel.createConfigItem(\n          [require('../../babel/plugins/next-page-config')],\n          { type: 'plugin' }\n        )\n        options.plugins.push(pageConfigPlugin)\n      }\n\n      if (isServer && source.indexOf('next/data') !== -1) {\n        const nextDataPlugin = babel.createConfigItem(\n          [\n            require('../../babel/plugins/next-data'),\n            { key: basename(filename) + '-' + hash(filename) },\n          ],\n          { type: 'plugin' }\n        )\n        options.plugins.push(nextDataPlugin)\n      }\n\n      if (isModern) {\n        const nextPreset = options.presets.find(\n          (preset) => preset && preset.value === nextBabelPreset\n        ) || { options: {} }\n\n        const additionalPresets = options.presets.filter(\n          (preset) => preset !== nextPreset\n        )\n\n        const presetItemModern = babel.createConfigItem(\n          nextBabelPresetModern(nextPreset.options),\n          {\n            type: 'preset',\n          }\n        )\n\n        options.presets = [...additionalPresets, presetItemModern]\n      }\n\n      // If the file has `module.exports` we have to transpile commonjs because Babel adds `import` statements\n      // That break webpack, since webpack doesn't support combining commonjs and esmodules\n      if (!hasModern && source.indexOf('module.exports') !== -1) {\n        options.plugins.push(applyCommonJs)\n      }\n\n      options.plugins.push([\n        require.resolve('babel-plugin-transform-define'),\n        {\n          'process.env.NODE_ENV': development ? 'development' : 'production',\n          'typeof window': isServer ? 'undefined' : 'object',\n          'process.browser': isServer ? false : true,\n        },\n        'next-js-transform-define-instance',\n      ])\n\n      if (isPageFile) {\n        if (!isServer) {\n          options.plugins.push([\n            require.resolve('../../babel/plugins/next-ssg-transform'),\n            {},\n          ])\n        }\n      }\n\n      // As next-server/lib has stateful modules we have to transpile commonjs\n      options.overrides = [\n        ...(options.overrides || []),\n        {\n          test: [\n            /next[\\\\/]dist[\\\\/]next-server[\\\\/]lib/,\n            /next[\\\\/]dist[\\\\/]client/,\n            /next[\\\\/]dist[\\\\/]pages/,\n          ],\n          plugins: [commonJsItem],\n        },\n      ]\n\n      for (const plugin of babelPresetPlugins) {\n        require(join(plugin.dir, 'src', 'babel-preset-build.js'))(\n          options,\n          plugin.config || {}\n        )\n      }\n\n      return options\n    },\n  }\n})\n"]}