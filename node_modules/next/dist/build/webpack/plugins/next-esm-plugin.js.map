{"version":3,"sources":["../../../../build/webpack/plugins/next-esm-plugin.ts"],"names":["SingleEntryPlugin","require","MultiEntryPlugin","JsonpTemplatePlugin","SplitChunksPlugin","RuntimeChunkPlugin","PLUGIN_NAME","IS_PRESET_ENV","PRESETS_WITH_USEBUILTINS","PLUGINS_WITH_USEBUILTINS","NextEsmPlugin","constructor","options","Object","assign","excludedPlugins","additionalPlugins","apply","compiler","hooks","make","tapAsync","compilation","callback","runBuild","then","getLoaders","rules","predicate","results","rule","Array","isArray","use","matches","filter","r","loader","length","push","ruleUse","ruleLoader","updateOptions","childCompiler","module","Error","babelLoader","includes","isModern","ensureModernBabelOptions","additionalBabelLoaders","test","presets","reduce","preset","name","opts","useBuiltIns","resolve","loose","plugins","map","plugin","updateAssets","childCompilation","assets","namedChunkGroups","unnamedChunks","childChunkFileMap","chunks","chunkMap","chunk","forEach","childChunk","files","v","values","entrypoints","entryPoint","entryPointName","childEntryPoint","get","hasOwnProperty","outputOptions","output","filename","chunkFilename","c","concat","createChildCompiler","context","inputFileSystem","outputFileSystem","compilerEntries","entry","index","keys","entryFiles","optimization","splitChunks","runtimeChunk","child","Promise","reject","started","optimizeChunkAssets","intercept","call","setTimeout","runAsChild","err","_entries","errors","optimizeAssets","tapPromise"],"mappings":"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","sourcesContent":["/**\n * MIT License\n *\n * Copyright (c) 2018 Prateek Bhatnagar\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\n/**\n * Webpack plugin for NextJs that runs a child compiler to generate a second (modern) JS bundle\n *\n * @author: Janicklas Ralph (https://github.com/janickals-ralph)\n *\n * Original source from which this was built upon - https://github.com/prateekbh/babel-esm-plugin\n */\nimport {\n  Compiler,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  compilation as CompilationType,\n  Plugin,\n  RuleSetRule,\n  RuleSetLoader,\n  Output,\n} from 'webpack'\n\nconst SingleEntryPlugin = require('webpack/lib/SingleEntryPlugin')\nconst MultiEntryPlugin = require('webpack/lib/MultiEntryPlugin')\nconst JsonpTemplatePlugin = require('webpack/lib/web/JsonpTemplatePlugin')\nconst SplitChunksPlugin = require('webpack/lib/optimize/SplitChunksPlugin')\nconst RuntimeChunkPlugin = require('webpack/lib/optimize/RuntimeChunkPlugin')\n\ntype BabelConfigItem = string | [string] | [string, any]\n\nconst PLUGIN_NAME = 'NextEsmPlugin'\n\n// Matches all variations of preset-env as a filepath.\n// Example: /project/foo/node_modules/babel-preset-react-app/dependencies.js\nconst IS_PRESET_ENV = /(^|[\\\\/])(babel-preset-react-app\\/dependencies(\\.js)?|@babel\\/(preset-)?env)([\\\\/]|$)/\n\n// Matches Babel preset paths that support the useBuiltIns option\nconst PRESETS_WITH_USEBUILTINS = /(^|[\\\\/])(@babel\\/(preset-)?react)([\\\\/]|$)/\n\n// Matches Babel plugin paths that support the useBuiltIns option\nconst PLUGINS_WITH_USEBUILTINS = /(^|[\\\\/])(@babel\\/(plugin-)?transform-react-jsx)([\\\\/]|$)/\n\nexport class NextEsmPlugin implements Plugin {\n  options: {\n    filename: any\n    chunkFilename: any\n    excludedPlugins: string[]\n    additionalPlugins: Plugin[]\n  }\n\n  constructor(options: {\n    filename: any\n    chunkFilename: any\n    excludedPlugins?: string[]\n    additionalPlugins?: any\n  }) {\n    this.options = Object.assign(\n      { excludedPlugins: [], additionalPlugins: [] },\n      options\n    )\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.make.tapAsync(PLUGIN_NAME, (compilation, callback) => {\n      this.runBuild(compiler, compilation).then(callback)\n    })\n  }\n\n  getLoaders(rules: RuleSetRule[], predicate: (loader: string) => boolean) {\n    const results = []\n    for (let rule of rules) {\n      if (Array.isArray(rule.use)) {\n        const matches = (rule.use as RuleSetLoader[]).filter(\n          (r) => r.loader && predicate(r.loader)\n        )\n        if (matches.length > 0) {\n          results.push(...matches)\n        }\n      }\n\n      const ruleUse = rule.use as RuleSetLoader\n      let ruleLoader = rule.loader\n      if (typeof ruleLoader === 'object' && 'loader' in ruleLoader) {\n        ruleLoader = ruleLoader.loader\n      }\n      if (\n        (ruleUse?.loader && predicate(ruleUse.loader)) ||\n        (ruleLoader && predicate(ruleLoader as string))\n      ) {\n        results.push(ruleUse || rule)\n      }\n    }\n    return results\n  }\n\n  updateOptions(childCompiler: Compiler) {\n    if (!childCompiler.options.module) {\n      throw new Error('Webpack.options.module not found!')\n    }\n\n    let babelLoader = this.getLoaders(\n      childCompiler.options.module.rules,\n      (loader) => loader.includes('next-babel-loader')\n    )[0]\n\n    if (!babelLoader) {\n      throw new Error('Babel-loader config not found!')\n    }\n\n    babelLoader.options = Object.assign({}, babelLoader.options, {\n      isModern: true,\n    })\n    if (typeof babelLoader.options !== 'string') {\n      this.ensureModernBabelOptions(babelLoader.options)\n    }\n\n    const additionalBabelLoaders = this.getLoaders(\n      childCompiler.options.module.rules,\n      (loader) => /(^|[\\\\/])babel-loader([\\\\/]|$)/.test(loader)\n    )\n    for (const loader of additionalBabelLoaders) {\n      // @TODO support string options?\n      if (!loader.options || typeof loader.options === 'string') continue\n      this.ensureModernBabelOptions(loader.options)\n    }\n  }\n\n  ensureModernBabelOptions(options: {\n    presets?: BabelConfigItem[]\n    plugins?: BabelConfigItem[]\n  }) {\n    // find and remove known ES2017-to-ES5 transforms\n    if (options.presets) {\n      options.presets = options.presets.reduce(\n        (presets: BabelConfigItem[], preset) => {\n          const name = Array.isArray(preset) ? preset[0] : preset\n          const opts = Object.assign(\n            {},\n            (Array.isArray(preset) && preset[1]) || {}\n          )\n\n          if (PRESETS_WITH_USEBUILTINS.test(name)) {\n            opts.useBuiltIns = true\n          }\n\n          if (IS_PRESET_ENV.test(name)) {\n            presets.push([\n              require.resolve('@babel/preset-modules'),\n              { loose: true },\n            ])\n          } else {\n            presets.push([name, opts])\n          }\n          return presets\n        },\n        []\n      )\n    }\n\n    if (options.plugins) {\n      options.plugins = options.plugins.map((plugin) => {\n        const name = Array.isArray(plugin) ? plugin[0] : plugin\n        const opts = Object.assign(\n          {},\n          (Array.isArray(plugin) && plugin[1]) || {}\n        )\n\n        if (PLUGINS_WITH_USEBUILTINS.test(name)) {\n          opts.useBuiltIns = true\n        }\n\n        return [name, opts]\n      })\n    }\n  }\n\n  updateAssets(\n    compilation: CompilationType.Compilation,\n    childCompilation: CompilationType.Compilation\n  ) {\n    compilation.assets = Object.assign(\n      childCompilation.assets,\n      compilation.assets\n    )\n\n    compilation.namedChunkGroups = Object.assign(\n      childCompilation.namedChunkGroups,\n      compilation.namedChunkGroups\n    )\n\n    const unnamedChunks: CompilationType.Chunk[] = []\n    const childChunkFileMap = childCompilation.chunks.reduce(\n      (\n        chunkMap: { [key: string]: CompilationType.Chunk },\n        chunk: CompilationType.Chunk\n      ) => {\n        // Dynamic chunks may not have a name. It'll be null in such cases\n        if (chunk.name === null) {\n          unnamedChunks.push(chunk)\n        } else {\n          chunkMap[chunk.name] = chunk\n        }\n\n        return chunkMap\n      },\n      {}\n    )\n\n    // Merge chunks - merge the files of chunks with the same name\n    compilation.chunks.forEach((chunk: CompilationType.Chunk) => {\n      const childChunk = childChunkFileMap[chunk.name]\n\n      // Do not merge null named chunks since they are different\n      if (chunk.name !== null && childChunk?.files) {\n        delete childChunkFileMap[chunk.name]\n        chunk.files.push(\n          ...childChunk.files.filter((v: any) => !chunk.files.includes(v))\n        )\n      }\n    })\n\n    // Add modern only chunks into the main compilation\n    compilation.chunks.push(\n      ...Object.values(childChunkFileMap),\n      ...unnamedChunks\n    )\n\n    // Place modern only (unmerged) chunks inside the right entry point\n    compilation.entrypoints.forEach((entryPoint, entryPointName) => {\n      const childEntryPoint = childCompilation.entrypoints.get(entryPointName)\n\n      childEntryPoint.chunks.forEach((chunk: CompilationType.Chunk) => {\n        if (\n          // Add null named dynamic chunks since they weren't merged\n          chunk.name === null ||\n          childChunkFileMap.hasOwnProperty(chunk.name)\n        ) {\n          entryPoint.chunks.push(chunk)\n        }\n      })\n    })\n  }\n\n  async runBuild(compiler: Compiler, compilation: CompilationType.Compilation) {\n    const outputOptions: Output = { ...compiler.options.output }\n\n    if (typeof this.options.filename === 'function') {\n      outputOptions.filename = this.options.filename(outputOptions.filename)\n    } else {\n      outputOptions.filename = this.options.filename\n    }\n\n    if (typeof this.options.chunkFilename === 'function') {\n      outputOptions.chunkFilename = this.options.chunkFilename(\n        outputOptions.chunkFilename\n      )\n    } else {\n      outputOptions.chunkFilename = this.options.chunkFilename\n    }\n\n    let plugins = (compiler.options.plugins || []).filter(\n      (c) =>\n        !(\n          this.options.excludedPlugins.includes(c.constructor.name) ||\n          c.constructor.name === PLUGIN_NAME\n        )\n    )\n\n    // Add the additionalPlugins\n    plugins = plugins.concat(this.options.additionalPlugins)\n\n    /**\n     * We are deliberately not passing plugins in createChildCompiler.\n     * All webpack does with plugins is to call `apply` method on them\n     * with the childCompiler.\n     * But by then we haven't given childCompiler a fileSystem or other options\n     * which a few plugins might expect while execution the apply method.\n     * We do call the `apply` method of all plugins by ourselves later in the code\n     */\n    const childCompiler = compilation.createChildCompiler(\n      PLUGIN_NAME,\n      outputOptions\n    )\n\n    childCompiler.context = compiler.context\n    childCompiler.inputFileSystem = compiler.inputFileSystem\n    childCompiler.outputFileSystem = compiler.outputFileSystem\n\n    // Call the `apply` method of all plugins by ourselves.\n    if (Array.isArray(plugins)) {\n      for (const plugin of plugins) {\n        plugin.apply(childCompiler)\n      }\n    }\n\n    let compilerEntries: any = compiler.options.entry\n    if (typeof compilerEntries === 'function') {\n      compilerEntries = await compilerEntries()\n    }\n    if (typeof compilerEntries === 'string') {\n      compilerEntries = { index: compilerEntries }\n    }\n\n    Object.keys(compilerEntries).forEach((entry) => {\n      const entryFiles = compilerEntries[entry]\n      if (Array.isArray(entryFiles)) {\n        new MultiEntryPlugin(compiler.context, entryFiles, entry).apply(\n          childCompiler\n        )\n      } else {\n        new SingleEntryPlugin(compiler.context, entryFiles, entry).apply(\n          childCompiler\n        )\n      }\n    })\n\n    // Convert entry chunk to entry file\n    new JsonpTemplatePlugin().apply(childCompiler)\n\n    const optimization = compiler.options.optimization\n    if (optimization) {\n      if (optimization.splitChunks) {\n        new SplitChunksPlugin(\n          Object.assign({}, optimization.splitChunks)\n        ).apply(childCompiler)\n      }\n\n      if (optimization.runtimeChunk) {\n        new RuntimeChunkPlugin(\n          Object.assign({}, optimization.runtimeChunk)\n        ).apply(childCompiler)\n      }\n    }\n\n    // Hold back the main compilation until our Child Compiler has completed so its assets get optimized\n    const child = new Promise((resolve, reject) => {\n      // Defer the child compiler until known main thread \"dead time\" (while Terser is doing minification in the background)\n      let started = false\n      compilation.hooks.optimizeChunkAssets.intercept({\n        call: () => {\n          // only run the first time optimizeChunkAssets is called\n          if (started) return\n          started = true\n\n          // Delay the Child Compiler until optimizeChunkAssets has had time to send work to the Terser pool\n          setTimeout(() => {\n            this.updateOptions(childCompiler)\n\n            childCompiler.runAsChild((err, _entries, childCompilation) => {\n              if (err) {\n                return reject(err)\n              }\n\n              if (childCompilation.errors.length > 0) {\n                return reject(childCompilation.errors[0])\n              }\n\n              this.updateAssets(compilation, childCompilation)\n              resolve()\n            })\n          }, 500)\n        },\n      })\n    })\n    compilation.hooks.optimizeAssets.tapPromise(PLUGIN_NAME, () => child)\n  }\n}\n"]}