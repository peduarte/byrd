{"version":3,"sources":["../../../../build/babel/plugins/next-page-config.ts"],"names":["replaceBundle","path","t","parentPath","replaceWith","program","variableDeclaration","variableDeclarator","identifier","STRING_LITERAL_DROP_BUNDLE","stringLiteral","Date","now","errorMessage","state","details","pageName","filename","split","cwd","pop","nextPageConfig","types","visitor","Program","enter","traverse","ExportNamedDeclaration","exportPath","exportState","bundleDropped","node","declaration","BabelTypes","isVariableDeclaration","declarations","config","isIdentifier","id","name","isObjectExpression","init","got","type","Error","prop","properties","isSpreadElement","key","isObjectProperty","isBooleanLiteral","value","isStringLiteral","amp","file","opts","caller","isDev"],"mappings":"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","sourcesContent":["import { NodePath, PluginObj, types as BabelTypes } from '@babel/core'\nimport { PageConfig } from 'next/types'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../next-server/lib/constants'\n\n// replace program path with just a variable with the drop identifier\nfunction replaceBundle(path: any, t: typeof BabelTypes): void {\n  path.parentPath.replaceWith(\n    t.program(\n      [\n        t.variableDeclaration('const', [\n          t.variableDeclarator(\n            t.identifier(STRING_LITERAL_DROP_BUNDLE),\n            t.stringLiteral(`${STRING_LITERAL_DROP_BUNDLE} ${Date.now()}`)\n          ),\n        ]),\n      ],\n      []\n    )\n  )\n}\n\nfunction errorMessage(state: any, details: string): string {\n  const pageName =\n    (state.filename || '').split(state.cwd || '').pop() || 'unknown'\n  return `Invalid page config export found. ${details} in file ${pageName}. See: https://err.sh/vercel/next.js/invalid-page-config`\n}\n\ninterface ConfigState {\n  bundleDropped?: boolean\n}\n\n// config to parsing pageConfig for client bundles\nexport default function nextPageConfig({\n  types: t,\n}: {\n  types: typeof BabelTypes\n}): PluginObj {\n  return {\n    visitor: {\n      Program: {\n        enter(path, state: ConfigState) {\n          path.traverse(\n            {\n              ExportNamedDeclaration(\n                exportPath: NodePath<BabelTypes.ExportNamedDeclaration>,\n                exportState: any\n              ) {\n                if (exportState.bundleDropped || !exportPath.node.declaration) {\n                  return\n                }\n\n                if (\n                  !BabelTypes.isVariableDeclaration(exportPath.node.declaration)\n                ) {\n                  return\n                }\n\n                const { declarations } = exportPath.node.declaration\n                const config: PageConfig = {}\n\n                for (const declaration of declarations) {\n                  if (\n                    !BabelTypes.isIdentifier(declaration.id, { name: 'config' })\n                  ) {\n                    continue\n                  }\n\n                  if (!BabelTypes.isObjectExpression(declaration.init)) {\n                    const got = declaration.init\n                      ? declaration.init.type\n                      : 'undefined'\n                    throw new Error(\n                      errorMessage(\n                        exportState,\n                        `Expected object but got ${got}`\n                      )\n                    )\n                  }\n\n                  for (const prop of declaration.init.properties) {\n                    if (BabelTypes.isSpreadElement(prop)) {\n                      throw new Error(\n                        errorMessage(\n                          exportState,\n                          `Property spread is not allowed`\n                        )\n                      )\n                    }\n                    const { name } = prop.key\n                    if (BabelTypes.isIdentifier(prop.key, { name: 'amp' })) {\n                      if (!BabelTypes.isObjectProperty(prop)) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Invalid property \"${name}\"`\n                          )\n                        )\n                      }\n                      if (\n                        !BabelTypes.isBooleanLiteral(prop.value) &&\n                        !BabelTypes.isStringLiteral(prop.value)\n                      ) {\n                        throw new Error(\n                          errorMessage(\n                            exportState,\n                            `Invalid value for \"${name}\"`\n                          )\n                        )\n                      }\n                      config.amp = prop.value.value as PageConfig['amp']\n                    }\n                  }\n                }\n\n                if (config.amp === true) {\n                  if (!exportState.file?.opts?.caller.isDev) {\n                    // don't replace bundle in development so HMR can track\n                    // dependencies and trigger reload when they are changed\n                    replaceBundle(exportPath, t)\n                  }\n                  exportState.bundleDropped = true\n                  return\n                }\n              },\n            },\n            state\n          )\n        },\n      },\n    },\n  }\n}\n"]}