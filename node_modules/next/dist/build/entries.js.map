{"version":3,"sources":["../../build/entries.ts"],"names":["createPagesMapping","pagePaths","extensions","previousPages","pages","reduce","result","pagePath","page","replace","RegExp","join","pageKey","chalk","cyan","PAGES_DIR_ALIAS","createEntrypoints","target","buildId","previewMode","config","loadedEnvFiles","client","server","hasRuntimeConfig","Object","keys","publicRuntimeConfig","length","serverRuntimeConfig","defaultServerlessOptions","absoluteAppPath","absoluteDocumentPath","absoluteErrorPath","distDir","DOT_NEXT_ALIAS","assetPrefix","generateEtags","poweredByHeader","canonicalBase","basePath","runtimeConfig","JSON","stringify","previewProps","Buffer","from","toString","forEach","absolutePagePath","bundleFile","isApiRoute","match","API_ROUTE","clientBundlePath","posix","serverBundlePath","isLikeServerless","serverlessLoaderOptions","pageLoaderOpts","pageLoader","require","resolve"],"mappings":"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","sourcesContent":["import chalk from 'next/dist/compiled/chalk'\nimport { posix, join } from 'path'\nimport { stringify } from 'querystring'\nimport { API_ROUTE, DOT_NEXT_ALIAS, PAGES_DIR_ALIAS } from '../lib/constants'\nimport { __ApiPreviewProps } from '../next-server/server/api-utils'\nimport { isTargetLikeServerless } from '../next-server/server/config'\nimport { normalizePagePath } from '../next-server/server/normalize-page-path'\nimport { warn } from './output/log'\nimport { ClientPagesLoaderOptions } from './webpack/loaders/next-client-pages-loader'\nimport { ServerlessLoaderQuery } from './webpack/loaders/next-serverless-loader'\nimport { LoadedEnvFiles } from '../lib/load-env-config'\n\ntype PagesMapping = {\n  [page: string]: string\n}\n\nexport function createPagesMapping(\n  pagePaths: string[],\n  extensions: string[]\n): PagesMapping {\n  const previousPages: PagesMapping = {}\n  const pages: PagesMapping = pagePaths.reduce(\n    (result: PagesMapping, pagePath): PagesMapping => {\n      let page = `${pagePath\n        .replace(new RegExp(`\\\\.+(${extensions.join('|')})$`), '')\n        .replace(/\\\\/g, '/')}`.replace(/\\/index$/, '')\n\n      const pageKey = page === '' ? '/' : page\n\n      if (pageKey in result) {\n        warn(\n          `Duplicate page detected. ${chalk.cyan(\n            join('pages', previousPages[pageKey])\n          )} and ${chalk.cyan(\n            join('pages', pagePath)\n          )} both resolve to ${chalk.cyan(pageKey)}.`\n        )\n      } else {\n        previousPages[pageKey] = pagePath\n      }\n      result[pageKey] = join(PAGES_DIR_ALIAS, pagePath).replace(/\\\\/g, '/')\n      return result\n    },\n    {}\n  )\n\n  pages['/_app'] = pages['/_app'] || 'next/dist/pages/_app'\n  pages['/_error'] = pages['/_error'] || 'next/dist/pages/_error'\n  pages['/_document'] = pages['/_document'] || 'next/dist/pages/_document'\n\n  return pages\n}\n\nexport type WebpackEntrypoints = {\n  [bundle: string]: string | string[]\n}\n\ntype Entrypoints = {\n  client: WebpackEntrypoints\n  server: WebpackEntrypoints\n}\n\nexport function createEntrypoints(\n  pages: PagesMapping,\n  target: 'server' | 'serverless' | 'experimental-serverless-trace',\n  buildId: string,\n  previewMode: __ApiPreviewProps,\n  config: any,\n  loadedEnvFiles: LoadedEnvFiles\n): Entrypoints {\n  const client: WebpackEntrypoints = {}\n  const server: WebpackEntrypoints = {}\n\n  const hasRuntimeConfig =\n    Object.keys(config.publicRuntimeConfig).length > 0 ||\n    Object.keys(config.serverRuntimeConfig).length > 0\n\n  const defaultServerlessOptions = {\n    absoluteAppPath: pages['/_app'],\n    absoluteDocumentPath: pages['/_document'],\n    absoluteErrorPath: pages['/_error'],\n    distDir: DOT_NEXT_ALIAS,\n    buildId,\n    assetPrefix: config.assetPrefix,\n    generateEtags: config.generateEtags,\n    poweredByHeader: config.poweredByHeader,\n    canonicalBase: config.canonicalBase,\n    basePath: config.basePath,\n    runtimeConfig: hasRuntimeConfig\n      ? JSON.stringify({\n          publicRuntimeConfig: config.publicRuntimeConfig,\n          serverRuntimeConfig: config.serverRuntimeConfig,\n        })\n      : '',\n    previewProps: JSON.stringify(previewMode),\n    // base64 encode to make sure contents don't break webpack URL loading\n    loadedEnvFiles: Buffer.from(JSON.stringify(loadedEnvFiles)).toString(\n      'base64'\n    ),\n  }\n\n  Object.keys(pages).forEach((page) => {\n    const absolutePagePath = pages[page]\n    const bundleFile = normalizePagePath(page)\n    const isApiRoute = page.match(API_ROUTE)\n\n    const clientBundlePath = posix.join('pages', bundleFile)\n    const serverBundlePath = posix.join('pages', bundleFile)\n\n    const isLikeServerless = isTargetLikeServerless(target)\n\n    if (isApiRoute && isLikeServerless) {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[serverBundlePath] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    } else if (isApiRoute || target === 'server') {\n      server[serverBundlePath] = [absolutePagePath]\n    } else if (isLikeServerless && page !== '/_app' && page !== '/_document') {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[serverBundlePath] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    }\n\n    if (page === '/_document') {\n      return\n    }\n\n    if (!isApiRoute) {\n      const pageLoaderOpts: ClientPagesLoaderOptions = {\n        page,\n        absolutePagePath,\n      }\n      const pageLoader = `next-client-pages-loader?${stringify(\n        pageLoaderOpts\n      )}!`\n\n      // Make sure next/router is a dependency of _app or else chunk splitting\n      // might cause the router to not be able to load causing hydration\n      // to fail\n\n      client[clientBundlePath] =\n        page === '/_app'\n          ? [pageLoader, require.resolve('../client/router')]\n          : pageLoader\n    }\n  })\n\n  return {\n    client,\n    server,\n  }\n}\n"]}